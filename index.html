<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SkyShield Ground Control System — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Custom Theme -->
  <link href="css/style.css" rel="stylesheet" />
</head>
<body class="login-page d-flex flex-column min-vh-100">

  <!-- Centered login card within vertically aligned container -->
  <div class="container flex-grow-1 d-flex align-items-center justify-content-center py-5">
    <div class="col-12 col-md-8 col-lg-5">
      <div class="text-center mb-3">
        <h1 class="display-6 fw-semibold text-hud mb-1">SkyShield Ground Control System</h1>
        <div class="text-uppercase small text-muted tracking-wide">Authorized Personnel Only</div>
      </div>

      <!-- Credential form -->
      <div class="card card-hud shadow-lg">
        <div class="card-body p-4">
          <div id="loginError" class="alert alert-danger d-none" role="alert"></div>
          <form id="loginForm" action="#" method="post" autocomplete="off" novalidate>
            <div class="mb-3">
              <label class="form-label" for="emailInput">Authorized Email</label>
              <input
                id="emailInput"
                type="email"
                class="form-control form-control-hud"
                placeholder="commander@skyshield.local"
                name="email"
                autocomplete="email"
                required />
              <div class="form-text text-muted">Use the briefing email assigned to your station.</div>
            </div>
            <div class="mb-4">
              <label class="form-label" for="passwordInput">Password</label>
              <input
                id="passwordInput"
                type="password"
                class="form-control form-control-hud"
                placeholder="Enter password"
                name="password"
                autocomplete="current-password"
                required />
            </div>
            <button id="loginSubmitBtn" type="submit" class="btn btn-success w-100 hud-glow">
              <i class="bi bi-shield-lock me-2"></i>Authenticate
            </button>
          </form>
        </div>
        <div class="card-footer small text-center text-muted">
          Need help? Open the <a href="manual.html" class="link-hud">Operator Manual</a>.
        </div>
      </div>
    </div>
  </div>

  <!-- Slim footer keeps branding consistent with other pages -->
  <footer class="text-center text-muted small py-3">
    © SkyShield 2025 – Ground Defense Command Unit
  </footer>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="js/auth.js"></script>
  <script>
    (function () {
      'use strict';

      if (!window.SkyShieldAuth) {
        console.error('SkyShieldAuth module failed to load.');
        return;
      }

      const form = document.getElementById('loginForm');
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');
      const submitBtn = document.getElementById('loginSubmitBtn');
      const errorBox = document.getElementById('loginError');
      const params = new URLSearchParams(window.location.search);
      const redirectTarget = sanitizeRedirect(params.get('redirect'));

      let unsubAuthListener = null;

      unsubAuthListener = window.SkyShieldAuth.onAuthChanged((user) => {
        if (user) {
          window.location.href = redirectTarget;
        }
      });

      window.addEventListener('beforeunload', () => {
        if (typeof unsubAuthListener === 'function') {
          unsubAuthListener();
        }
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        clearMessages();

        await handleLogin();
      });

      async function handleLogin() {
        setLoading(true, 'Authenticating…');
        const result = await window.SkyShieldAuth.loginWithEmail(emailInput.value, passwordInput.value);
        setLoading(false);

        if (!result.ok) {
          showError(result.message);
          passwordInput.value = '';
          passwordInput.focus();
          return;
        }

        form.reset();
        window.location.href = redirectTarget;
      }

      function setLoading(isLoading, label) {
        submitBtn.disabled = isLoading;
        submitBtn.classList.toggle('disabled', isLoading);
        if (isLoading && label) {
          submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${label}`;
        } else if (!isLoading) {
          submitBtn.innerHTML = '<i class="bi bi-shield-lock me-2"></i>Authenticate';
        }
      }

      function showError(message) {
        errorBox.textContent = message;
        errorBox.classList.remove('d-none');
      }

      function clearMessages() {
        errorBox.classList.add('d-none');
        errorBox.textContent = '';
      }

      function sanitizeRedirect(target) {
        if (!target || /^https?:\/\//i.test(target)) {
          return 'control.html';
        }
        return target;
      }
    })();
  </script>
</body>
</html>
